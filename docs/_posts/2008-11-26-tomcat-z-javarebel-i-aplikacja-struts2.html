---
layout: post
title: Tomcat z JavaRebel i aplikacja Struts2
date: '2008-11-26T21:10:00.003+01:00'
author: Tomasz Nurkiewicz
tags:
- struts2
- javarebel
- tomcat
modified_time: '2009-03-28T22:20:44.294+01:00'
blogger_id: tag:blogger.com,1999:blog-6753769565491687768.post-6456386112261378981
blogger_orig_url: https://www.nurkiewicz.com/2008/11/tomcat-z-javarebel-i-aplikacja-struts2.html
---

Ponieważ od kilku dni mogę się pochwalić brązowym pasem na JavaBlackBelt, postanowiłem wypróbować narzędzie JavaRebel, do którego to licencję <a href="http://www.javablackbelt.com/NewsView.wwa?newsId=7644325">otrzymałem za darmo</a>. Padło na aplikację w Struts2 na Tomkacie 6.0, zacznijmy od niej:<br /><br /><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>mvn archetype:create -DgroupId=strutstest -DartifactId=strutstest -DarchetypeGroupId=org.apache.struts -DarchetypeArtifactId=struts2-archetype-starter -DarchetypeVersion=2.0.11.2-SNAPSHOT -DremoteRepositories=http://people.apache.org/repo/m2-snapshot-repository<br /></code></pre><br /><br />I aplikacja gotowa. Teraz czas przygotować Tomcata, na szczęście ogranicza się to do dodania dwóch magicznych linijek do skryptu catalina.bat:<br /><br /><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>set JAVA_OPTS=-noverify -javaagent:C:/apps/JavaRebel/1.2.1/javarebel.jar %JAVA_OPTS%<br />set JAVA_OPTS=-Drebel.dirs=D:/temp/strutstest/target/classes %JAVA_OPTS%<br /></code></pre><br /><br />Pierwsza komenda wskazuje ścieżkę do JARa JavaRebel i jest dość oczywista. Druga wskazuje katalog, w którym maven (i - jak się za chwilę przekonamy - Eclipse) umieszcza skompilowane pliki .class. Innym rozwiązaniem jest skonfigurowanie mavena/Eclipsa tak, aby kompilował bezpośrednio do katalogu z rozpakowanym WARem (w naszym wypadku webapps/strutstest w Tomkacie), ale to wydaje się dużo gorszym podejściem, chociaż nie wymaga podawania explicite katalogu w naszej przestrzeni roboczej.<br /><br />Po zbudowaniu projektu i uruchomieniu Tomcata ujrzałem:<br /><br /><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>##########################################################<br /><br />ZeroTurnaround JavaRebel 1.2.1 (200809261633)<br />(c) Copyright Webmedia, Ltd, 2007, 2008. All rights reserved.<br /><br />This product is licensed to Tomasz Nurkiewicz<br /><br />##########################################################<br /><br />JavaRebel: Directory 'D:\temp\strutstest\target\classes' will be monitored for class changes.<br /></code></pre><br />Super, plugin JavaRebel działa. Ważne, by wcześniej zbudować nasz przykładowy projekt, inaczej otrzymamy komunikat z ostrzeżeniem, że wskazany katalog nie istnieje.<br /><br />Wracamy do naszej aplikacji. mvn clean package buduje WARa, którego szybciutko wdrażamy w Tomkacie i... niemiła niespodzianka:<br /><br /><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>java.lang.NoClassDefFoundError: Lorg/apache/velocity/app/VelocityEngine;<br />at java.lang.Class.getDeclaredFields0(Native Method)<br />at java.lang.Class.privateGetDeclaredFields(Class.java:2291)<br />at java.lang.Class.getDeclaredFields(Class.java:1743)<br />at com.opensymphony.xwork2.inject.ContainerImpl.addInjectors(ContainerImpl.java:102)<br />at com.opensymphony.xwork2.inject.ContainerImpl$1.create(ContainerImpl.java:84)<br />at com.opensymphony.xwork2.inject.ContainerImpl$1.create(ContainerImpl.java:82)<br />at com.opensymphony.xwork2.inject.util.ReferenceCache$CallableCreate.call(ReferenceCache.java:155)<br />at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br />at java.util.concurrent.FutureTask.run(FutureTask.java:138)<br />at com.opensymphony.xwork2.inject.util.ReferenceCache.internalCreate(ReferenceCache.java:81)<br />at com.opensymphony.xwork2.inject.util.ReferenceCache.get(ReferenceCache.java:121)<br />at com.opensymphony.xwork2.inject.ContainerImpl$ConstructorInjector.(ContainerImpl.java:329)<br />at com.opensymphony.xwork2.inject.ContainerImpl$5.create(ContainerImpl.java:299)<br />at com.opensymphony.xwork2.inject.ContainerImpl$5.create(ContainerImpl.java:298)<br />at com.opensymphony.xwork2.inject.util.ReferenceCache$CallableCreate.call(ReferenceCache.java:155)<br />at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br />at java.util.concurrent.FutureTask.run(FutureTask.java:138)<br />at com.opensymphony.xwork2.inject.util.ReferenceCache.internalCreate(ReferenceCache.java:81)<br />at com.opensymphony.xwork2.inject.util.ReferenceCache.get(ReferenceCache.java:121)<br />at com.opensymphony.xwork2.inject.ContainerImpl.getConstructor(ContainerImpl.java:562)<br />at com.opensymphony.xwork2.inject.ContainerImpl.inject(ContainerImpl.java:460)<br />at com.opensymphony.xwork2.inject.ContainerImpl$7.call(ContainerImpl.java:501)<br />at com.opensymphony.xwork2.inject.ContainerImpl.callInContext(ContainerImpl.java:549)<br />at com.opensymphony.xwork2.inject.ContainerImpl.inject(ContainerImpl.java:499)<br />at com.opensymphony.xwork2.config.impl.LocatableFactory.create(LocatableFactory.java:32)<br />at com.opensymphony.xwork2.inject.ContainerBuilder$4.create(ContainerBuilder.java:134)<br />at com.opensymphony.xwork2.inject.Scope$2$1.create(Scope.java:49)<br />at com.opensymphony.xwork2.inject.ContainerImpl$ParameterInjector.inject(ContainerImpl.java:431)<br />at com.opensymphony.xwork2.inject.ContainerImpl.getParameters(ContainerImpl.java:446)<br />at com.opensymphony.xwork2.inject.ContainerImpl.access$000(ContainerImpl.java:48)<br />at com.opensymphony.xwork2.inject.ContainerImpl$MethodInjector.inject(ContainerImpl.java:288)<br />at com.opensymphony.xwork2.inject.ContainerImpl$2.call(ContainerImpl.java:117)<br />at com.opensymphony.xwork2.inject.ContainerImpl$2.call(ContainerImpl.java:115)<br />at com.opensymphony.xwork2.inject.ContainerImpl.callInContext(ContainerImpl.java:542)<br />at com.opensymphony.xwork2.inject.ContainerImpl.injectStatics(ContainerImpl.java:114)<br />at com.opensymphony.xwork2.inject.ContainerBuilder.create(ContainerBuilder.java:494)<br />at com.opensymphony.xwork2.config.impl.DefaultConfiguration.reload(DefaultConfiguration.java:145)<br />at com.opensymphony.xwork2.config.ConfigurationManager.getConfiguration(ConfigurationManager.java:52)<br />at org.apache.struts2.dispatcher.Dispatcher.init_PreloadConfiguration(Dispatcher.java:395)<br />at org.apache.struts2.dispatcher.Dispatcher.init(Dispatcher.java:452)<br />at org.apache.struts2.dispatcher.FilterDispatcher.init(FilterDispatcher.java:201)<br />at org.apache.catalina.core.ApplicationFilterConfig.getFilter(ApplicationFilterConfig.java:275)<br />at org.apache.catalina.core.ApplicationFilterConfig.setFilterDef(ApplicationFilterConfig.java:397)<br />at org.apache.catalina.core.ApplicationFilterConfig.(ApplicationFilterConfig.java:108)<br />at org.apache.catalina.core.StandardContext.filterStart(StandardContext.java:3709)<br />at org.apache.catalina.core.StandardContext.start(StandardContext.java:4363)<br />at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:791)<br />at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:771)<br />at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:525)<br />at org.apache.catalina.startup.HostConfig.deployWAR(HostConfig.java:830)<br />at org.apache.catalina.startup.HostConfig.deployWARs(HostConfig.java:719)<br />at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:490)<br />at org.apache.catalina.startup.HostConfig.check(HostConfig.java:1217)<br />at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:293)<br />at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)<br />at org.apache.catalina.core.ContainerBase.backgroundProcess(ContainerBase.java:1337)<br />at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1601)<br />at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1610)<br />at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1590)<br />at java.lang.Thread.run(Thread.java:619)<br />Caused by: java.lang.ClassNotFoundException: org.apache.velocity.app.VelocityEngine<br />at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1387)<br />at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1233)<br />at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:320)<br />... 60 more<br /></code></pre><br /><br />Szybki restart Tomcata, już z wyłączonym JavaRebel, i aplikacja wdraża się i działa bez zarzutu... Google wskazuje mi link do problemu na <a href="https://issues.apache.org/struts/browse/WW-2228">Strutsowym JIRA</a>. Co prawda pracuję na zupełnie innym środowisku (oficjalna Java, Windows XP), jednak włączony JavaRebel objawia się dokładnie tak samo. W wolnej chwili może zgłoszę to developerom. Z wielkim żalem dodaję do mojego poma ponoć opcjonalne zależności:<br /><br /><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>&lt;dependency&gt;<br />&lt;groupId&gt;velocity&lt;/groupId&gt;<br />&lt;artifactId&gt;velocity&lt;/artifactId&gt;<br />&lt;version&gt;1.4&lt;/version&gt;<br />&lt;/dependency&gt;<br />&lt;dependency&gt;<br />&lt;groupId&gt;velocity-tools&lt;/groupId&gt;<br />&lt;artifactId&gt;velocity-tools-view&lt;/artifactId&gt;<br />&lt;version&gt;1.2&lt;/version&gt;<br />&lt;/dependency&gt;<br /></code></pre><br /><br />I próbuję ponownie. Ufff... działa. Lekkie rozczarowanie (wynikowy artefakt większy o prawie 1 MiB), jednak nie traćmy nadziei. Pora wreszcie wypróbować możliwości tego narzędzia. Importuję projekt do środowiska Eclipse (File -> Import -> Maven Projects) i przechodzę do metody execute() klasy IndexAction. Jest ona wywoływana za każdy razem, gdy wchodzimy na adres http://localhost:8080/strutstest/index.action:<br /><br /><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>public String execute() throws Exception {<br />now = new Date(System.currentTimeMillis());<br />return SUCCESS;<br />}<br /></code></pre><br />Data w zmiennej <span style="font-family:courier new;">now</span> zostanie wyświetlona w polu tekstowym na stronie HTML. Zmieńmy ten kod na następujący:<br /><br /><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>Calendar date = Calendar.getInstance();<br />date.set(Calendar.YEAR, 2007);<br />now = date.getTime();<br />return SUCCESS;<br /></code></pre>Po odświeżeniu strony na konsoli ukazał się komunikat:<br /><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>JavaRebel: Reloading class 'com.blogspot.nurkiewicz.IndexAction'.<br /></code></pre>A strona zawierała zaktualizowaną datę. Działa, ale zmienić treść metody w runtime to ponoć i JVM sama potrafi. A zatem dodajmy metodę:<br /><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>public String execute() throws Exception {<br /> now = getNow();<br /> return SUCCESS;<br />}<br /><br />private Date getNow() {<br /> Calendar date = Calendar.getInstance();<br /> date.set(Calendar.YEAR, 2006);<br /> return date.getTime();<br />}<br /></code></pre>Ten sam komunikat na konsoli i zmiana została uwzględniona - czyli jakaś wartość dodana jest. Spróbujmy zatem teraz stworzyć nową klasę i skorzystać z niej:<br /><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>package com.blogspot.nurkiewicz;<br /><br />import java.util.Calendar;<br />import java.util.Date;<br /><br />public class DateUtil {<br /><br />public Date getNow() {<br />  Calendar date = Calendar.getInstance();<br />  date.set(Calendar.YEAR, 2006);<br />  return date.getTime();<br />}<br /><br />}<br /></code></pre><br /><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>    public String execute() throws Exception {<br />   DateUtil dateUtil = new DateUtil();<br />   now = dateUtil.getNow();<br />   return SUCCESS;<br />}<br /></code></pre><br />F5 i...<br /><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>JavaRebel: Reloading class 'com.blogspot.nurkiewicz.IndexAction'.<br />JavaRebel: A non-fatal exception has occured, it may mean that this dependency is missing - com.blogspot.nurkiewicz.DateUtil<br />JavaRebel: A non-fatal exception has occured, it may mean that this dependency is missing - com.blogspot.nurkiewicz.DateUtil<br /></code></pre>Ależ plik <span style="font-family:courier new;">DateUtil.class</span> jest na miejscu! Ani ponowne zbudowanie całego projektu, ani nawet restart Tomkata nic nie dał, JavaRebel nadal nie widzi nowej klasy, która ewidentnie tkwi w monitorowanym katalogu...<br />Szczerze mówiąc spodziewałem się czegoś bardziej spektakularnego i łatwego w użyciu, zwłaszcza po narzędziu komercyjnym, które ponoć <a href="http://www.zeroturnaround.com/javarebel/features/">oferuje taką funkcjonalność</a>. Póki co odkładam JavaRebel na półkę, może przyda się w innym projekcie/frameworku :-(. Liczę też na czytelników, może zwyczajnie źle korzystam z narzędzia?<br /><br />P.S.: Pisałbym na bloga częściej, ale jakość edytora na blogspocie jest tragiczna. Po roku pracy z Confluence wiki konieczność ręcznego escapowania znaków większy-niż i mniejszy-niż wygląda groteskowo...