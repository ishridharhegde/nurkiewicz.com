---
layout: post
title: 'Spock VW: writing custom Spock framework extensions'
date: '2015-10-08T21:26:00.001+02:00'
author: Tomasz Nurkiewicz
tags:
- testing
- groovy
- Spock
modified_time: '2020-02-08T22:19:04.497+01:00'
blogger_id: tag:blogger.com,1999:blog-6753769565491687768.post-5756010559787673825
blogger_orig_url: https://www.nurkiewicz.com/2015/10/spock-vw-writing-custom-spock-framework.html
---

<a href="https://github.com/spockframework/spock">Spock framework</a> has multiple <a href="https://spockframework.github.io/spock/docs/1.0/extensions.html">built-in extensions</a> that support many core features like <code>@Ignore</code> and <code>@Timeout</code> annotations. But more importantly developers are encouraged to write their own extensions. For example <code>SpringExtension</code> nicely integrates Spock with Spring framework. Writing custom extensions is not very well documented. In this article we will write very simple extension. It is not a comprehensive guide but just a funny showcase.<br /><br /><h1 id="introducing-spock-vw-extension">Introducing Spock VW extension</h1>In some engineering branches<sup><a href="https://en.wikipedia.org/wiki/Volkswagen_emissions_scandal">[1]</a></sup> rigorous tests must pass only when external audit is looking. In programming this would be a continuous integration server. <em>Spock VW extension</em> makes sure all tests pass on CI server, even if they fail on developers machine or on production. The idea is heavily inspired by <a href="https://github.com/hmlb/phpunit-vw"><em>phpunit-vw</em></a>. Let's take this simple, completely made up test that can't possibly succeed:<br /><br /><pre class="prettyprint linenums">@Unroll<br />class EmissionsSpec extends Specification {<br /><br />    def 'nitrogen oxide emission (#emission) in #model must not exceed #allowed'() {<br />        expect:<br />            emission &lt;= allowed<br />        where:<br />            model    | emission || allowed<br />            'Jetty'  | 1.5      || 0.022<br />            'Pascal' | 0.67     || 0.016<br />    }<br /><br />    def 'carbon dioxide'() {<br />        expect:<br />            105 &lt; 130<br />    }<br />}</pre>First test obviously fails for both samples, but we can transparently add a Spock extension that will make sure no CI server ever catches this issue. The extension simply examines all system properties and environment variables, trying to discover if the host environment is actually a CI server:<br /><br /><pre class="prettyprint linenums">package com.nurkiewicz.vw<br /><br />import org.spockframework.runtime.extension.IGlobalExtension<br />import org.spockframework.runtime.model.SpecInfo<br /><br /><br />class VwExtension implements IGlobalExtension {<br /><br />    private static final CONTROLLED_ENV = [<br />            'bamboo.buildKey',<br />            'BUILD_ID', 'BUILD_NUMBER', 'BUILDKITE',<br />            'CI', 'CIRCLECI',<br />            'CONTINUOUS_INTEGRATION',<br />            'GOCD_SERVER_HOST',<br />            'HUDSON_URL', 'JENKINS_URL',<br />            'TEAMCITY_VERSION',<br />            'TRAVIS',<br />    ]<br /><br />    private static final boolean EVERYTHING_IS_FINE =<br />            CONTROLLED_ENV.any {prop -&gt;<br />                System.getProperty(prop) || System.getenv(prop)}<br /><br />    @Override<br />    void visitSpec(SpecInfo spec) {<br />        if (EVERYTHING_IS_FINE) {<br />            spec.features*.skipped = true<br />        }<br />    }<br />}</pre><code>VwExtension</code> is like an aspect around every <code>Specification</code> you have in your codebase. It examines a list of known environment variables and if <code>any()</code> of them is present (<a href="http://gunshowcomic.com/648"><code>EVERYTHING_IS_FINE</code></a> constant), all <code>features</code> (tests) within this <code>Spec</code> are skipped. One more thing. Extensions are not discovered automatically, you must create a special <code>org.spockframework.runtime.extension.IGlobalExtension</code> file under <code>META-INF/services</code> directory on the CLASSPATH (of course it can be in a different JAR). The content of that file is simply a fully qualified name of the extension class, e.g. <code>com.nurkiewicz.vw.VwExtension</code>.<br /><br />That's about it, happy testing!