---
layout: post
title: 'SiftingAppender: logging different threads to different log files'
date: '2013-04-14T13:45:00.000+02:00'
author: Tomasz Nurkiewicz
tags:
- logging
- logback
modified_time: '2013-04-14T13:45:46.068+02:00'
blogger_id: tag:blogger.com,1999:blog-6753769565491687768.post-3524034460938078548
blogger_orig_url: https://www.nurkiewicz.com/2013/04/siftingappender-logging-different.html
---

One novel feature of Logback is <a href="http://logback.qos.ch/manual/appenders.html#SiftingAppender"><code>SiftingAppender</code></a> (<a href="http://logback.qos.ch/apidocs/ch/qos/logback/access/sift/SiftingAppender.html">JavaDoc</a>). In short it's a proxy appender that creates one child appender per each unique value of a given runtime property. Typically this property is taken from <a href="http://logback.qos.ch/manual/mdc.html">MDC</a>. Here is an example based on the official documentation linked above:<br /><br /><pre class="brush: xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;configuration&gt;<br /><br />    &lt;appender name="SIFT" class="ch.qos.logback.classic.sift.SiftingAppender"&gt;<br />        &lt;discriminator&gt;<br />            &lt;key&gt;userid&lt;/key&gt;<br />            &lt;defaultValue&gt;unknown&lt;/defaultValue&gt;<br />        &lt;/discriminator&gt;<br />        &lt;sift&gt;<br />            &lt;appender name="FILE-${userid}" class="ch.qos.logback.core.FileAppender"&gt;<br />                &lt;file&gt;user-${userid}.log&lt;/file&gt;<br />                &lt;layout class="ch.qos.logback.classic.PatternLayout"&gt;<br />                    &lt;pattern&gt;%d{HH:mm:ss:SSS} | %-5level | %thread | %logger{20} | %msg%n%rEx&lt;/pattern&gt;<br />                &lt;/layout&gt;<br />            &lt;/appender&gt;<br />        &lt;/sift&gt;<br />    &lt;/appender&gt;<br /><br />    &lt;root level="ALL"&gt;<br />        &lt;appender-ref ref="SIFT" /&gt;<br />    &lt;/root&gt;<br />&lt;/configuration&gt;<br /></pre>Notice that the <code>&lt;file&gt;</code> property is parameterized with <code>${userid}</code> property. Where does this property come from? It has to be placed in MDC. For example in a web application using <a href="http://static.springsource.org/spring-security/site/index.html">Spring Security</a> I tend to use a servlet filter with a help of <a href="http://static.springsource.org/spring-security/site/docs/3.1.x/apidocs/org/springframework/security/core/context/SecurityContextHolder.html"><code>SecurityContextHolder</code></a>:<br /><br /><a name='more'></a><br /><br /><pre class="brush: scala">import javax.servlet._<br />import org.slf4j.MDC<br />import org.springframework.security.core.context.SecurityContextHolder<br />import org.springframework.security.core.userdetails.UserDetails<br /><br />class UserIdFilter extends Filter<br />{<br />    def init(filterConfig: FilterConfig) {}<br /><br />    def doFilter(request: ServletRequest, response: ServletResponse, chain: FilterChain) {<br />        val userid = Option(<br />            SecurityContextHolder.getContext.getAuthentication<br />        ).collect{case u: UserDetails =&gt; u.getUsername}<br /><br />        MDC.put("userid", userid.orNull)<br />        try {<br />            chain.doFilter(request, response)<br />        } finally {<br />            MDC.remove("userid")<br />        }<br /><br />    }<br /><br />    def destroy() {}<br />}<br /></pre>Just make sure this filter is applied after Spring Security filter. But that's not the point. The presence of <code>${userid}</code> placeholder in the file name causes sifting appender to create one child appender for each different value of this property (thus: different user names). Running your web application with this configuration will quickly create several log files like <code>user-alice.log</code>, <code>user-bob.log</code> and <code>user-unknown.log</code> in case of MDC property not set.<br /><br />Another use case is using thread name rather than MDC property. Unfortunately this is not built in, but can be easily plugged in using custom <a href="http://logback.qos.ch/apidocs/ch/qos/logback/core/sift/Discriminator.html"><code>Discriminator</code></a> as opposed to default <a href="http://logback.qos.ch/apidocs/ch/qos/logback/classic/sift/MDCBasedDiscriminator.html"><code>MDCBasedDiscriminator</code></a>:<br /><br /><pre class="brush: java">public class ThreadNameBasedDiscriminator implements Discriminator&lt;ILoggingEvent&gt; {<br /><br />    private static final String KEY = "threadName";<br /><br />    private boolean started;<br /><br />    @Override<br />    public String getDiscriminatingValue(ILoggingEvent iLoggingEvent) {<br />        return Thread.currentThread().getName();<br />    }<br /><br />    @Override<br />    public String getKey() {<br />        return KEY;<br />    }<br /><br />    public void start() {<br />        started = true;<br />    }<br /><br />    public void stop() {<br />        started = false;<br />    }<br /><br />    public boolean isStarted() {<br />        return started;<br />    }<br />}<br /></pre>Now we have to instruct <code>logback.xml</code> to use our custom discriminator:<br /><br /><pre class="brush: xml">&lt;appender name="SIFT" class="ch.qos.logback.classic.sift.SiftingAppender"&gt;<br />    &lt;discriminator class="com.blogspot.nurkiewicz.ThreadNameBasedDiscriminator"/&gt;<br />    &lt;sift&gt;<br />        &lt;appender class="ch.qos.logback.core.FileAppender"&gt;<br />            &lt;file&gt;app-${threadName}.log&lt;/file&gt;<br />            &lt;layout class="ch.qos.logback.classic.PatternLayout"&gt;<br />                &lt;pattern&gt;%d{HH:mm:ss:SSS} | %-5level | %logger{20} | %msg%n%rEx&lt;/pattern&gt;<br />            &lt;/layout&gt;<br />        &lt;/appender&gt;<br />    &lt;/sift&gt;<br />&lt;/appender&gt;<br /></pre>Note that we no longer put <code>%thread</code> in <code>PatternLayout</code> - it is unnecessary as thread name is part of the log file name:<br /><br /><ul><li><code>app-main.log</code></li><li><code>app-http-nio-8080-exec-1.log</code></li><li><code>app-taskScheduler-1</code></li><li><code>app-ForkJoinPool-1-worker-1.log</code></li><li>...and so forth</li></ul>This is probably not the most convenient setup for server application, but on desktop where you have a limited number of focused threads like <a href="http://en.wikipedia.org/wiki/Event_dispatching_thread">EDT</a>, IO thread, etc. it might be a vital alternative.  <script src="https://raw.github.com/gist/3983275/936845e66d98bb7c627684df7884f33b2cc368f5/syntaxhighlighter.js"></script>